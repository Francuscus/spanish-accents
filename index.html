<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Transcriptor dialectal (ES) — Cádiz / Dominicana</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; padding: 24px; max-width: 900px; margin: 0 auto; line-height: 1.4; }
    h1 { margin-top: 0; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 880px) {
      .row { grid-template-columns: 1fr 300px; }
    }
    textarea { width: 100%; min-height: 140px; font-size: 16px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .feature-item { display: flex; gap: 8px; align-items: center; }
    .output { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #fafafa; border-radius: 8px; padding: 12px; white-space: pre-wrap; }
    .controls { display: flex; gap: 12px; align-items: center; }
    .muted { color: #666; font-size: 14px; }
    .small { font-size: 12px; color: #666; }
    button { cursor: pointer; border: 1px solid #333; border-radius: 8px; padding: 8px 12px; background: #111; color: #fff; }
    select, input[type="checkbox"] { cursor: pointer; }
    label { user-select: none; }
  </style>
</head>
<body>
  <h1>Transcriptor dialectal (ES)</h1>
  <p class="muted">Corrige únicamente <strong>ch → tʃ</strong> (por eso <em>chico</em> ya no sale <em>kico</em>). Todo lo demás queda básico y funcional.</p>

  <div class="row">
    <div class="panel">
      <div class="grid">
        <div class="controls">
          <label for="dialect">Dialecto:</label>
          <select id="dialect">
            <option value="neutral">Neutral</option>
            <option value="cadiz">Cádiz</option>
            <option value="dominican">Dominicana</option>
          </select>
          <label><input type="checkbox" id="showSyllables" /> Mostrar sílabas</label>
          <button id="goBtn">Transcribir</button>
        </div>

        <label for="inputText"><strong>Texto de entrada</strong></label>
        <textarea id="inputText" placeholder="Pegá acá tu texto..."></textarea>

        <div id="outputSection" style="display:none;">
          <label><strong>Salida</strong></label>
          <div class="output" id="transcriptionResult"></div>
          <div class="small">Entre corchetes [ ] se muestra la transcripción completa.</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Rasgos / toggles</h3>
      <div class="grid">
        <div class="feature-item">
          <input type="checkbox" id="liquidSubCadiz" />
          <label for="liquidSubCadiz">Liquid substitution r→l̪ (Cádiz)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="nVelarization" />
          <label for="nVelarization">N-velarization n→ŋ (Dominicana)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="ceceo" />
          <label for="ceceo">Ceceo (c/z/s→θ en contexto)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="finalRDeletionCadiz" />
          <label for="finalRDeletionCadiz">Final r-deletion en infinitivos (Cádiz)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="finalSDeletion" />
          <label for="finalSDeletion">Eliminar -s final de palabra</label>
        </div>

        <!-- Extras (no toco su lógica si no los usás) -->
        <div class="feature-item">
          <input type="checkbox" id="sAspiration" />
          <label for="sAspiration">Aspiración de -s final (simple)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="sDelete" />
          <label for="sDelete">Eliminar /s/ intervocálica (muy simplificado)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="assibilatedR" />
          <label for="assibilatedR">R asibilada (experimental)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="sheismo" />
          <label for="sheismo">Sheísmo (ʝ→ʃ/ʒ muy simplificado)</label>
        </div>
        <div class="feature-item">
          <input type="checkbox" id="finalRDeletion" />
          <label for="finalRDeletion">Eliminar /r/ final (global, simple)</label>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --------------------------------------------
    // Utilidades básicas
    // --------------------------------------------
    const vowels = 'aeiou';
    const weakVowels = 'iu';
    const strongVowels = 'aeo';
    // Conjunto de consonantes (incluye ŋ)
    const consonants = 'bβdðgɣptkfθsxmnlrɾʝtʃɲjwŋRʃʒ';
    // Clústeres típicos de ataque en español
    const validClusters = ['bl','br','kl','kr','dr','fl','fr','gl','gr','pl','pr','tr'];

    // --------------------------------------------
    // 1) Orto → Fonemas (muy básico)
    //     * ÚNICO FIX: 'ch' → 'tʃ' antes que nada
    // --------------------------------------------
    function orthographyToPhonemes(word, dialect, features) {
      let w = (word || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');

      // ---- FIX ÚNICO pedido: 'ch' → 'tʃ' ----
      w = w.replace(/ch/g, 'tʃ');

      // Reglas simples de grafema → fonema
      // qu -> k (quita la u muda)
      w = w.replace(/qu/g, 'k');
      // güe/güi (ignoramos diéresis y tratamos como 'ge/gi' simple aquí)
      w = w.replace(/gue/g, 'ge').replace(/gui/g, 'gi');

      // Ceceo opcional (c/z/s → θ en contextos de /e,i/ para 'c'; z siempre θ)
      if (features.ceceo || dialect === 'cadiz') {
        w = w
          .replace(/c(?=[ei])/g, 'θ')
          .replace(/z/g, 'θ')
          .replace(/s/g, 'θ'); // opción fuerte (muy simplificada)
      } else {
        // Distinción simple por defecto:
        // c + e,i → θ; z → θ; s → s
        w = w.replace(/c(?=[ei])/g, 'θ');
        w = w.replace(/c/g, 'k');
        w = w.replace(/z/g, 'θ');
      }

      // g + e,i → ʝ (aprox. yeísmo para /ʝ/)
      w = w.replace(/g(?=[ei])/g, 'ʝ');

      // j → x (velar fricativa sorda)
      w = w.replace(/j/g, 'x');

      // h muda: eliminar
      w = w.replace(/h/g, '');

      // y → ʝ (muy simplificado)
      w = w.replace(/y/g, 'ʝ');

      // b/v → b (luego se puede alófono β entre vocales, si quisieras)
      w = w.replace(/v/g, 'b');

      // k queda k, t, p, f, m, n, l, r, rr etc.
      // rr → R (trill)
      w = w.replace(/rr/g, 'R');
      // r intervocálica → ɾ (tap), r inicial de palabra → r (tratamos luego)
      // dejamos como 'r' y lo afinamos en sílabas

      return w;
    }

    // --------------------------------------------
    // 2) Sílaba: diptongos/hiatos (básico) + segmentación
    // --------------------------------------------
    function syllabify(phonSeq, originalWord) {
      // Resolver diptongos mínimos (i/u como semiconsonantes)
      let processed = '';
      for (let i = 0; i < phonSeq.length; i++) {
        const a = phonSeq[i];
        const b = phonSeq[i + 1];
        if (vowels.includes(a) && vowels.includes(b)) {
          // i/u + vocal → deslizada
          if (weakVowels.includes(a) && !weakVowels.includes(b)) {
            processed += (a === 'i' ? 'j' : 'w') + b;
            i++;
            continue;
          }
          if (!weakVowels.includes(a) && weakVowels.includes(b)) {
            processed += a + (b === 'i' ? 'j' : 'w');
            i++;
            continue;
          }
        }
        processed += a;
      }

      // Segmentación muy básica CV (con clústeres válidos)
      const sylls = [];
      let cur = '';
      let i = 0;
      while (i < processed.length) {
        const ch = processed[i];
        cur += ch;

        // si es vocal → posible corte de sílaba
        if (vowels.includes(ch)) {
          // Mirar consonantes siguientes
          let j = i + 1;
          let cons = '';
          while (j < processed.length && !vowels.includes(processed[j])) {
            cons += processed[j];
            j++;
          }
          if (cons.length === 0) {
            sylls.push(cur);
            cur = '';
            i++;
            continue;
          }

          if (cons.length === 1) {
            // V C V → la C pasa al ataque siguiente
            sylls.push(cur);
            cur = cons;
            i = i + 1 + 1; // vocal + 1 cons
            continue;
          }

          // dos o más consonantes: si las dos últimas forman clúster, se van juntas
          const lastTwo = cons.slice(-2);
          if (validClusters.includes(lastTwo)) {
            // coda + (clúster) al ataque
            const coda = cons.slice(0, -2);
            cur += coda;
            sylls.push(cur);
            cur = lastTwo;
            i = j;
          } else {
            // se separa antes de la última
            const coda = cons.slice(0, -1);
            cur += coda;
            sylls.push(cur);
            cur = cons.slice(-1);
            i = j;
          }
          continue;
        }
        i++;
      }
      if (cur) sylls.push(cur);
      return sylls;
    }

    // --------------------------------------------
    // 3) Acento (ˈ) por defecto español
    // --------------------------------------------
    function applyStress(syllables, originalWord) {
      if (!syllables.length) return syllables.slice();

      // Regla ortográfica simplificada: si hay tilde en original, la ignoramos aquí
      // y aplicamos acento por defecto: palabra llana si termina en vocal/n/s; aguda en otro caso.
      const lastSyl = syllables[syllables.length - 1];
      const endsWith = (c) => originalWord?.toLowerCase().endsWith(c);

      const endsLikeVowelNS =
        endsWith('a') || endsWith('e') || endsWith('i') || endsWith('o') || endsWith('u') ||
        endsWith('n') || endsWith('s');

      const idx = endsLikeVowelNS
        ? Math.max(0, syllables.length - 2) // penúltima
        : syllables.length - 1;            // última

      return syllables.map((s, i) => (i === idx ? ('ˈ' + s) : s));
    }

    // --------------------------------------------
    // 4) Reglas dialectales / toggles
    // --------------------------------------------
    function applyRules(syllables, dialect, features) {
      const out = syllables.map((syl, index, arr) => {
        let s = syl;

        // (opcional) Yeísmo rioplatense (muy grosero)
        if (features.sheismo) {
          s = s.replace(/ʝ/g, 'ʃ');
        }

        // Aspiración -s final (simple)
        if (features.sAspiration) {
          s = s.replace(/s(?=\b)/g, 'h');
        }

        // Eliminar /s/ intervocálica (muy simplificado)
        if (features.sDelete) {
          s = s.replace(/(?<=[aeiou])s(?=[aeiou])/g, '');
        }

        // Eliminar -s final de palabra
        if (features.finalSDeletion && index === arr.length - 1) {
          s = s.replace(/s$/, '');
        }

        // Eliminar /r/ final global (si se enciende ese toggle)
        if (features.finalRDeletion && index === arr.length - 1) {
          s = s.replace(/[ɾrR]$/, '');
        }

        // Cádiz: sustitución líquida r/ɾ → l̪ en coda o final
        if (dialect === 'cadiz' && features.liquidSubCadiz) {
          const isLast = index === arr.length - 1;
          if (isLast) {
            s = s.replace(/[ɾrR]$/, 'l̪');
          }
          // r/ɾ antes de consonante dentro de sílaba
          s = s.replace(/[ɾrR](?=[bβdðgɣptkfθsxmnɲʝtʃjʃʒRθjwŋ])/g, 'l̪');
        }

        // Cádiz: borrar r final de infinitivos (aprox. aɾ/eɾ/iɾ)
        if (dialect === 'cadiz' && features.finalRDeletionCadiz && index === arr.length - 1) {
          if (/(a|e|i)ɾ$/.test(s)) s = s.replace(/ɾ$/, '');
        }

        // Dominicana: n final → ŋ
        if (dialect === 'dominican' && features.nVelarization && index === arr.length - 1) {
          s = s.replace(/n$/, 'ŋ');
        }

        // (opcional) r asibilada (experimental)
        if (features.assibilatedR) {
          s = s.replace(/r|ɾ|R/g, 'ʐ'); // puramente indicativo
        }

        return s;
      });

      return out;
    }

    // --------------------------------------------
    // 5) Transcripción completa del texto
    // --------------------------------------------
    function transcribe() {
      const input = document.getElementById('inputText').value || '';
      const dialect = document.getElementById('dialect').value;

      const features = {
        liquidSubCadiz: document.getElementById('liquidSubCadiz').checked,
        nVelarization: document.getElementById('nVelarization').checked,
        ceceo: document.getElementById('ceceo').checked,
        finalRDeletionCadiz: document.getElementById('finalRDeletionCadiz').checked,
        finalSDeletion: document.getElementById('finalSDeletion').checked,
        sAspiration: document.getElementById('sAspiration').checked,
        sDelete: document.getElementById('sDelete').checked,
        assibilatedR: document.getElementById('assibilatedR').checked,
        sheismo: document.getElementById('sheismo').checked,
        finalRDeletion: document.getElementById('finalRDeletion').checked,
        showSyllables: document.getElementById('showSyllables').checked
      };

      // Tokenización simple (separamos puntuación común, incluyendo ¿¡)
      const tokens = input
        .toLowerCase()
        .replace(/[.,;:!?¡¿()«»"“”'’\[\]{}]/g, ' ')
        .split(/\s+/)
        .filter(w => w.trim().length > 0);

      const results = [];

      for (const word of tokens) {
        let phon = orthographyToPhonemes(word, dialect, features);
        let sylls = syllabify(phon, word);
        sylls = applyStress(sylls, word);
        sylls = applyRules(sylls, dialect, features);
        results.push(features.showSyllables ? sylls.join('.') : sylls.join(''));
      }

      document.getElementById('transcriptionResult').textContent = `[${results.join(' ')}]`;
      document.getElementById('outputSection').style.display = 'block';
    }

    document.getElementById('goBtn').addEventListener('click', transcribe);

    // Demo mínima para que pruebes rápido
    document.getElementById('inputText').value = 'chico muchacha hacer canción corazón andar comer vivir';
  </script>
</body>
</html>
